# Job definitions for Account Monitor
# Uses SQL Warehouse (can be serverless or provisioned)

resources:
  jobs:
    # ==========================================================================
    # FIRST INSTALL JOB - Run this once to set up everything
    # ==========================================================================
    account_monitor_first_install:
      name: "[${bundle.target}] Account Monitor - First Install"
      description: "Complete first-time setup: creates schema, loads contracts, populates data, and trains ML model"

      tasks:
        # Phase 1: Schema Setup
        - task_key: create_schema
          description: "Create Unity Catalog schema and tables"
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/setup_schema.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: create_forecast_schema
          description: "Create forecast tables"
          depends_on:
            - task_key: create_schema
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/create_forecast_schema.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: create_whatif_schema
          description: "Create what-if simulation tables"
          depends_on:
            - task_key: create_forecast_schema
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/create_whatif_schema.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        # Phase 2: Load Configuration (Contracts + Discount Tiers)
        - task_key: load_contract_config
          description: "Load contracts and discount tiers from config files"
          depends_on:
            - task_key: create_whatif_schema
          notebook_task:
            notebook_path: ../notebooks/setup_contracts.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              config_files: ${var.config_files}
              discount_tiers_file: ${var.discount_tiers_file}
            source: WORKSPACE

        # Phase 3: Populate Data from System Tables
        - task_key: refresh_dashboard_data
          description: "Load dashboard data from system.billing.usage"
          depends_on:
            - task_key: load_contract_config
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/refresh_dashboard_data.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
          timeout_seconds: 3600

        - task_key: refresh_contract_burndown
          description: "Calculate contract burndown metrics"
          depends_on:
            - task_key: refresh_dashboard_data
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/refresh_contract_burndown.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: optimize_tables
          description: "Optimize Delta tables"
          depends_on:
            - task_key: refresh_contract_burndown
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/optimize_tables.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        # Phase 4: Train ML Model and Generate Forecasts
        - task_key: build_forecast_features
          description: "Prepare forecast feature data"
          depends_on:
            - task_key: refresh_contract_burndown
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/build_forecast_features.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: train_and_forecast
          description: "Train Prophet model and generate forecasts"
          depends_on:
            - task_key: build_forecast_features
            - task_key: optimize_tables
          notebook_task:
            notebook_path: ../notebooks/consumption_forecaster.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              mode: "both"
              forecast_horizon_days: "365"
              confidence_interval: "0.80"
              min_training_days: "30"
            source: WORKSPACE
          timeout_seconds: 7200

        # Phase 5: What-If Simulation
        - task_key: run_whatif_simulation
          description: "Generate what-if discount scenarios"
          depends_on:
            - task_key: train_and_forecast
          notebook_task:
            notebook_path: ../notebooks/whatif_simulator.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
            source: WORKSPACE
          timeout_seconds: 3600

        # Phase 6: Validation
        - task_key: validate_installation
          description: "Verify all data is ready"
          depends_on:
            - task_key: run_whatif_simulation
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/validate_first_install.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

      max_concurrent_runs: 1

      tags:
        bundle: account_monitor
        environment: ${bundle.target}
        type: first_install

    # ==========================================================================
    # REGULAR JOBS - Scheduled for ongoing operation
    # ==========================================================================

    # Setup job - Creates Unity Catalog tables
    account_monitor_setup:
      name: "[${bundle.target}] Account Monitor - Setup"
      description: "Creates Unity Catalog schema and tables for account monitoring"

      tasks:
        - task_key: create_schema
          description: "Create Unity Catalog schema and tables"
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/setup_schema.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: load_contract_config
          description: "Load contracts from config files"
          depends_on:
            - task_key: create_schema
          notebook_task:
            notebook_path: ../notebooks/setup_contracts.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              config_files: ${var.config_files}
            source: WORKSPACE

      tags:
        bundle: account_monitor
        environment: ${bundle.target}

    # Daily refresh job
    account_monitor_daily_refresh:
      name: "[${bundle.target}] Account Monitor - Daily Refresh"
      description: "Daily refresh of dashboard data from system tables"

      tasks:
        - task_key: refresh_dashboard_data
          description: "Refresh dashboard data table"
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/refresh_dashboard_data.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
          timeout_seconds: 3600

        - task_key: refresh_contract_burndown
          description: "Refresh contract burndown data"
          depends_on:
            - task_key: refresh_dashboard_data
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/refresh_contract_burndown.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: optimize_tables
          description: "Optimize dashboard tables"
          depends_on:
            - task_key: refresh_contract_burndown
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/optimize_tables.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: check_data_freshness
          description: "Validate data freshness"
          depends_on:
            - task_key: optimize_tables
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/check_data_freshness.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: build_forecast_features
          description: "Prepare forecast feature data"
          depends_on:
            - task_key: refresh_contract_burndown
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/build_forecast_features.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: run_forecast_inference
          description: "Generate consumption forecasts"
          depends_on:
            - task_key: build_forecast_features
          notebook_task:
            notebook_path: ../notebooks/consumption_forecaster.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              mode: "inference"
              forecast_horizon_days: "365"
              confidence_interval: "0.80"
              min_training_days: "30"
            source: WORKSPACE
          timeout_seconds: 3600

        - task_key: run_whatif_simulation
          description: "Generate what-if discount scenarios"
          depends_on:
            - task_key: run_forecast_inference
          notebook_task:
            notebook_path: ../notebooks/whatif_simulator.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
            source: WORKSPACE
          timeout_seconds: 3600

      schedule:
        quartz_cron_expression: "0 0 2 * * ?"  # Daily at 2 AM
        timezone_id: "UTC"
        pause_status: UNPAUSED

      max_concurrent_runs: 1

      tags:
        bundle: account_monitor
        environment: ${bundle.target}
        schedule: daily

    # Weekly contract review job
    account_monitor_weekly_review:
      name: "[${bundle.target}] Account Monitor - Weekly Review"
      description: "Weekly contract consumption and cost analysis"

      tasks:
        - task_key: contract_analysis
          description: "Analyze contract consumption"
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/contract_analysis.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: cost_anomalies
          description: "Check for cost anomalies"
          depends_on:
            - task_key: contract_analysis
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/cost_anomalies.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: top_consumers
          description: "Identify top consuming resources"
          depends_on:
            - task_key: cost_anomalies
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/top_consumers.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

      schedule:
        quartz_cron_expression: "0 0 8 ? * MON"  # Every Monday at 8 AM
        timezone_id: "UTC"
        pause_status: UNPAUSED

      tags:
        bundle: account_monitor
        environment: ${bundle.target}
        schedule: weekly

    # Monthly summary job
    account_monitor_monthly_summary:
      name: "[${bundle.target}] Account Monitor - Monthly Summary"
      description: "Monthly cost and usage summary report"

      tasks:
        - task_key: monthly_summary
          description: "Generate monthly summary"
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/monthly_summary.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: archive_old_data
          description: "Archive data older than 2 years"
          depends_on:
            - task_key: monthly_summary
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/archive_old_data.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

      schedule:
        quartz_cron_expression: "0 0 6 1 * ?"  # First day of month at 6 AM
        timezone_id: "UTC"
        pause_status: UNPAUSED

      tags:
        bundle: account_monitor
        environment: ${bundle.target}
        schedule: monthly

    # Weekly model training job
    account_monitor_weekly_training:
      name: "[${bundle.target}] Account Monitor - Weekly Training"
      description: "Weekly Prophet model training for consumption forecasting"

      tasks:
        - task_key: create_forecast_schema
          description: "Ensure forecast tables exist"
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/create_forecast_schema.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: build_forecast_features
          description: "Prepare forecast feature data"
          depends_on:
            - task_key: create_forecast_schema
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/build_forecast_features.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

        - task_key: train_prophet_models
          description: "Train Prophet models for all contracts"
          depends_on:
            - task_key: build_forecast_features
          notebook_task:
            notebook_path: ../notebooks/consumption_forecaster.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              mode: "both"
              forecast_horizon_days: "365"
              confidence_interval: "0.80"
              min_training_days: "30"
            source: WORKSPACE
          timeout_seconds: 7200

        - task_key: run_whatif_simulation
          description: "Generate what-if discount scenarios"
          depends_on:
            - task_key: train_prophet_models
          notebook_task:
            notebook_path: ../notebooks/whatif_simulator.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
            source: WORKSPACE
          timeout_seconds: 3600

      schedule:
        quartz_cron_expression: "0 0 3 ? * SUN"  # Every Sunday at 3 AM
        timezone_id: "UTC"
        pause_status: UNPAUSED

      max_concurrent_runs: 1

      tags:
        bundle: account_monitor
        environment: ${bundle.target}
        schedule: weekly
        ml: forecasting

    # ==========================================================================
    # UPDATE DISCOUNT TIERS - Lightweight job for tier changes
    # ==========================================================================
    account_monitor_update_discount_tiers:
      name: "[${bundle.target}] Account Monitor - Update Discount Tiers"
      description: "Update discount tiers using MERGE (incremental). Optionally refreshes What-If scenarios."

      tasks:
        - task_key: update_tiers
          description: "MERGE discount tiers from config file"
          notebook_task:
            notebook_path: ../notebooks/update_discount_tiers.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
              discount_tiers_file: ${var.discount_tiers_file}
            source: WORKSPACE
          timeout_seconds: 600

        - task_key: refresh_whatif
          description: "Regenerate What-If scenarios with updated tiers"
          depends_on:
            - task_key: update_tiers
          notebook_task:
            notebook_path: ../notebooks/whatif_simulator.py
            base_parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}
            source: WORKSPACE
          timeout_seconds: 3600

      # No schedule - manual run only
      max_concurrent_runs: 1

      tags:
        bundle: account_monitor
        environment: ${bundle.target}
        type: config_update

    # ==========================================================================
    # CLEANUP JOB - Run this to wipe all data and start fresh
    # ==========================================================================
    account_monitor_cleanup:
      name: "[${bundle.target}] Account Monitor - Cleanup"
      description: "Drop all tables and views to start from scratch. WARNING: Deletes all data!"

      tasks:
        - task_key: cleanup_schema
          description: "Drop all Account Monitor tables and views"
          sql_task:
            warehouse_id: ${var.warehouse_id}
            file:
              path: ../sql/cleanup_schema.sql
            parameters:
              catalog: ${var.catalog}
              schema: ${var.schema}

      # No schedule - manual run only
      max_concurrent_runs: 1

      tags:
        bundle: account_monitor
        environment: ${bundle.target}
        type: cleanup
