# Databricks Asset Bundle Configuration
# Account Monitor - Cost and Usage Tracking

bundle:
  name: account_monitor

# Use the DEFAULT CLI profile (e2-demo-field-eng)
workspace:
  profile: DEFAULT

# Variables that can be overridden per environment
variables:
  catalog:
    description: Unity Catalog name for tables
    default: main

  schema:
    description: Schema name for account monitoring tables
    default: account_monitoring

  warehouse_id:
    description: SQL Warehouse ID (serverless or provisioned)
    default: "4b9b953939869799"  # Shared Unity Catalog Serverless

  max_projected_end_date:
    description: Maximum projected end date for contract burndown calculations
    default: "2032-12-31"

  config_files:
    description: Comma-separated list of contract config files to load
    default: "config/contracts.yml"

  discount_tiers_file:
    description: Path to discount tiers configuration file
    default: "config/discount_tiers.yml"

  state_suffix:
    description: Suffix for state path to avoid lineage conflicts (e.g., profile name or machine name)
    default: "default"

# Include configuration files
include:
  - resources/*.yml

# Deployment targets
# Note: state_path uses state_suffix variable to avoid lineage conflicts across machines
# Override state_suffix when deploying from different machines:
#   databricks bundle deploy --var state_suffix=my_laptop
targets:
  # Development environment
  dev:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/account_monitor
      state_path: /Workspace/Users/${workspace.current_user.userName}/account_monitor/.bundle/dev/state_${var.state_suffix}
    variables:
      catalog: main
      schema: account_monitoring_dev

  # Production environment
  prod:
    mode: production
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/account_monitor
      state_path: /Workspace/Users/${workspace.current_user.userName}/account_monitor/.bundle/prod/state_${var.state_suffix}
    variables:
      catalog: main
      schema: account_monitoring

    # Production validation
    run_as:
      # Run jobs as service principal in production
      service_principal_name: account_monitor_sp

# Permissions
permissions:
  - level: CAN_MANAGE
    user_name: ${workspace.current_user.userName}

# Sync configuration for development
sync:
  # Include only files needed for deployment
  include:
    # All notebooks (jobs + manual operations)
    - "notebooks/**"
    # SQL files used by jobs
    - "sql/setup_schema.sql"
    - "sql/create_forecast_schema.sql"
    - "sql/refresh_dashboard_data.sql"
    - "sql/refresh_contract_burndown.sql"
    - "sql/optimize_tables.sql"
    - "sql/build_forecast_features.sql"
    - "sql/validate_first_install.sql"
    - "sql/check_data_freshness.sql"
    - "sql/contract_analysis.sql"
    - "sql/cost_anomalies.sql"
    - "sql/top_consumers.sql"
    - "sql/monthly_summary.sql"
    - "sql/archive_old_data.sql"
    # What-If simulation SQL files
    - "sql/create_whatif_schema.sql"
    - "sql/populate_discount_tiers.sql"
    - "sql/refresh_whatif_scenarios.sql"
    - "sql/cleanup_schema.sql"
    # Config files read by notebooks (include all yml files)
    - "config/*.yml"

  # Exclude these patterns
  exclude:
    - .git
    - .venv
    - __pycache__
    - "*.pyc"
    - .env
    - .DS_Store
    - "*.log"
    - .databricks
    - "*.bak"
    - sync.sh
    - sync_to_workspace.py
    - resources/**
    - docs/**
