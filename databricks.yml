# Databricks Asset Bundle Configuration
# Account Monitor - Cost and Usage Tracking

bundle:
  name: account_monitor

# Use the LPT_FREE_EDITION CLI profile
workspace:
  profile: LPT_FREE_EDITION

# Variables that can be overridden per environment
variables:
  catalog:
    description: Unity Catalog name for tables
    default: main

  schema:
    description: Schema name for account monitoring tables
    default: account_monitoring

  warehouse_id:
    description: SQL Warehouse ID (serverless or provisioned)
    default: "58d41113cb262dce"  # Serverless Starter Warehouse

  max_projected_end_date:
    description: Maximum projected end date for contract burndown calculations
    default: "2032-12-31"

# Include configuration files
include:
  - resources/*.yml

# Deployment targets
targets:
  # Development environment
  dev:
    mode: development
    default: true
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/account_monitor
    variables:
      catalog: main
      schema: account_monitoring_dev

  # Production environment
  prod:
    mode: production
    workspace:
      root_path: /Workspace/Users/${workspace.current_user.userName}/account_monitor
    variables:
      catalog: main
      schema: account_monitoring

    # Production validation
    run_as:
      # Run jobs as service principal in production
      service_principal_name: account_monitor_sp

# Permissions
permissions:
  - level: CAN_MANAGE
    user_name: ${workspace.current_user.userName}

# Sync configuration for development
sync:
  # Include only files needed for deployment
  include:
    # All notebooks (jobs + manual operations)
    - "notebooks/**"
    # SQL files used by jobs
    - "sql/setup_schema.sql"
    - "sql/create_forecast_schema.sql"
    - "sql/refresh_dashboard_data.sql"
    - "sql/refresh_contract_burndown.sql"
    - "sql/optimize_tables.sql"
    - "sql/build_forecast_features.sql"
    - "sql/validate_first_install.sql"
    - "sql/check_data_freshness.sql"
    - "sql/contract_analysis.sql"
    - "sql/cost_anomalies.sql"
    - "sql/top_consumers.sql"
    - "sql/monthly_summary.sql"
    - "sql/archive_old_data.sql"
    # Config files read by notebooks
    - "config/contracts.yml"

  # Exclude these patterns
  exclude:
    - .git
    - .venv
    - __pycache__
    - "*.pyc"
    - .env
    - .DS_Store
    - "*.log"
    - .databricks
    - "*.bak"
    - sync.sh
    - sync_to_workspace.py
    - resources/**
    - docs/**
